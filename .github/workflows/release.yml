name: Release Traversal System

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git author
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Switch to default branch
        shell: pwsh
        run: |
          $defaultBranch = "${{ github.event.repository.default_branch }}"
          git fetch origin $defaultBranch --depth=1
          git checkout $defaultBranch

      - name: Update LOCAL_VERSION_TAG from tag
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $file = "TraversalSystem/main.py"
          (Get-Content $file) -replace 'LOCAL_VERSION_TAG = "v[0-9.]+"', "LOCAL_VERSION_TAG = `"$tag`"" | Set-Content $file -Encoding utf8
          if (-not (git status --porcelain)) {
            Write-Host "LOCAL_VERSION_TAG already set to $tag. No commit needed."
          } else {
            git add $file
            git commit -m "chore: bump version to $tag"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.event.repository.default_branch }}
          }

      - name: Detect requirements change vs previous tag
        shell: pwsh
        run: |
          $current = "${{ github.ref_name }}"
          $prev = git tag --sort=-creatordate | Where-Object { $_ -ne $current } | Select-Object -First 1
          if (-not $prev) {
            $changed = $false
          } else {
            $diff = git diff $prev $current -- requirements.txt
            $changed = -not [string]::IsNullOrWhiteSpace($diff)
          }
          "REQUIREMENTS_CHANGED=$changed" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Compute safe tag
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $safe = $tag -replace '\.', ''
          "SAFE_TAG=$safe" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Build Traversal executable (onedir)
        run: |
          pyinstaller TraversalSystem/main.py --onedir --name TraversalSystem_$Env:SAFE_TAG --distpath TraversalSystem/pyinstaller --workpath TraversalSystem/pyinstaller/build --specpath TraversalSystem/pyinstaller --python-option u --noconfirm

      - name: Prepare release bundle
        shell: pwsh
        run: |
          $distRoot = "TraversalSystem/pyinstaller/TraversalSystem_$Env:SAFE_TAG"
          $bundleDir = "release-bundle/TraversalSystem"
          New-Item -ItemType Directory -Force -Path $bundleDir | Out-Null
          Copy-Item "$distRoot/*" -Destination $bundleDir -Recurse -Force
          Copy-Item "TraversalSystem/photos.txt","TraversalSystem/res.csv","TraversalSystem/route.txt","TraversalSystem/settings.ini" -Destination $bundleDir -Force
          Copy-Item "TraversalSystem/sequences" -Destination $bundleDir -Recurse -Force
          Copy-Item "README.md","LICENSE" -Destination $bundleDir -Force

      - name: Create zip archive
        id: zip
        shell: pwsh
        run: |
          $zipName = "TraversalSystem_$Env:SAFE_TAG.zip"
          Compress-Archive -Path "release-bundle/*" -DestinationPath $zipName -Force
          echo "zip_path=$zipName" >> $Env:GITHUB_OUTPUT
          echo "exe_path=TraversalSystem/pyinstaller/TraversalSystem_$Env:SAFE_TAG/TraversalSystem_$Env:SAFE_TAG.exe" >> $Env:GITHUB_OUTPUT

      - name: Extract release notes from CHANGELOG
        id: changelog
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"

          NOTES=$(awk -v ver="$VERSION" '
            /^[#]+ \[/ {
              if (found) exit
              if ($0 ~ "\\[" ver "\\]") {
                found=1
                next
              }
            }
            found && !/^[#]+ \[/ { print }
          ' CHANGELOG.md)

          if [ -z "$NOTES" ]; then
            echo "Error: Could not find version $VERSION in CHANGELOG.md"
            exit 1
          fi

          echo "$NOTES" > release_notes.txt
          echo "Release notes extracted for version $VERSION"

      - name: Create GitHub release and upload asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $zip = "${{ steps.zip.outputs.zip_path }}"
          $exe = "${{ steps.zip.outputs.exe_path }}"
          $notesFile = "release_notes.txt"
          if ($Env:REQUIREMENTS_CHANGED -eq "True") {
            $notes = "Dependencies changed since the previous release. Download the zip and update following the README. No standalone exe is provided for this tag."
            Add-Content -Path $notesFile -Value ""
            Add-Content -Path $notesFile -Value $notes
            gh release create $tag $zip --title $tag --notes-file $notesFile
          } else {
            $notes = "Use the zip for fresh installs. The standalone exe is for updates only (drop it over an existing install)."
            Add-Content -Path $notesFile -Value ""
            Add-Content -Path $notesFile -Value $notes
            gh release create $tag $zip $exe --title $tag --notes-file $notesFile
          }
