name: Release Traversal System

on:
  push:
    tags:
      - "v*"

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect requirements change vs previous tag
        shell: pwsh
        run: |
          $current = "${{ github.ref_name }}"
          $prev = git tag --sort=-creatordate | Where-Object { $_ -ne $current } | Select-Object -First 1
          if (-not $prev) {
            $changed = $false
          } else {
            $diff = git diff $prev $current -- requirements.txt
            $changed = -not [string]::IsNullOrWhiteSpace($diff)
          }
          "REQUIREMENTS_CHANGED=$changed" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Compute safe tag
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $safe = $tag -replace '\.', ''
          "SAFE_TAG=$safe" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Build Traversal executable (onedir)
        run: |
          pyinstaller TraversalSystem/main.py --onedir --name TraversalSystem_$Env:SAFE_TAG --distpath TraversalSystem/pyinstaller --workpath TraversalSystem/pyinstaller/build --specpath TraversalSystem/pyinstaller --python-option u --noconfirm

      - name: Prepare release bundle
        shell: pwsh
        run: |
          $distRoot = "TraversalSystem/pyinstaller/TraversalSystem_$Env:SAFE_TAG"
          $bundleDir = "release-bundle/TraversalSystem"
          New-Item -ItemType Directory -Force -Path $bundleDir | Out-Null
          Copy-Item "$distRoot/*" -Destination $bundleDir -Recurse -Force
          Copy-Item "TraversalSystem/photos.txt","TraversalSystem/res.csv","TraversalSystem/route.txt","TraversalSystem/settings.ini" -Destination $bundleDir -Force
          Copy-Item "TraversalSystem/sequences" -Destination $bundleDir -Recurse -Force
          Copy-Item "README.md","LICENSE" -Destination $bundleDir -Force

      - name: Create zip archive
        id: zip
        shell: pwsh
        run: |
          $zipName = "TraversalSystem_$Env:SAFE_TAG.zip"
          Compress-Archive -Path "release-bundle/*" -DestinationPath $zipName -Force
          echo "zip_path=$zipName" >> $Env:GITHUB_OUTPUT
          echo "exe_path=TraversalSystem/pyinstaller/TraversalSystem_$Env:SAFE_TAG/TraversalSystem_$Env:SAFE_TAG.exe" >> $Env:GITHUB_OUTPUT

      - name: Create GitHub release and upload asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $zip = "${{ steps.zip.outputs.zip_path }}"
          $exe = "${{ steps.zip.outputs.exe_path }}"
          if ($Env:REQUIREMENTS_CHANGED -eq "True") {
            $notes = "Dependencies changed since the previous release. Download the zip and update following the README. No standalone exe is provided for this tag."
            gh release create $tag $zip --title $tag --notes "$notes"
          } else {
            $notes = "Use the zip for fresh installs. The standalone exe is for updates only (drop it over an existing install)."
            gh release create $tag $zip $exe --title $tag --notes "$notes"
          }
